<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{fragmentos :: cabecalho('Disruptive Architectures - Dashboard IoT/IOB/IA')}" />
<style>
	@keyframes blink {
		0%, 100% { 
			opacity: 1; 
			transform: scale(1);
		}
		50% { 
			opacity: 0.7; 
			transform: scale(1.05);
		}
	}
	.blink {
		animation: blink 1s infinite;
	}
	.alert-badge {
		position: absolute;
		top: -8px;
		right: -8px;
		background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
		color: white;
		border-radius: 50%;
		width: 26px;
		height: 26px;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 12px;
		font-weight: bold;
		border: 2px solid white;
		box-shadow: 0 2px 4px rgba(0,0,0,0.3);
		animation: pulse 2s infinite;
	}
	@keyframes pulse {
		0%, 100% { transform: scale(1); }
		50% { transform: scale(1.2); }
	}
	.stats-card {
		transition: transform 0.3s ease, box-shadow 0.3s ease;
		height: 100%;
	}
	.stats-card:hover {
		transform: translateY(-5px);
		box-shadow: 0 8px 16px rgba(0,0,0,0.2);
	}
	.refresh-btn {
		position: fixed;
		bottom: 20px;
		right: 20px;
		z-index: 1000;
		border-radius: 50%;
		width: 60px;
		height: 60px;
		box-shadow: 0 4px 12px rgba(0,0,0,0.3);
	}
	.refresh-btn:hover {
		transform: rotate(180deg);
		transition: transform 0.5s ease;
	}
	.moto-icon {
		font-size: 18px;
		margin-right: 4px;
	}
</style>

<body>
	<div th:replace="~{fragmentos :: navbar}" />

	<div class="container py-4">
		<div th:replace="~{fragmentos :: saudacoes(${usuario_logado})}" />

		<!-- Header -->
		<div class="row mb-4">
			<div class="col-12">
				<h1 class="mb-2">
					<i class="fas fa-microchip me-2 text-primary"></i>Disruptive Architectures
				</h1>
				<p class="text-muted">IoT, IOB & Generative IA - Dashboard de Localização Inteligente</p>
			</div>
		</div>

		<!-- Dashboard de Estatísticas -->
		<div class="row mb-4">
			<div class="col-md-3 mb-3">
				<div class="card border-primary stats-card">
					<div class="card-body text-center">
						<h5 class="card-title"><i class="fas fa-motorcycle text-primary fa-2x mb-2"></i><br>Total</h5>
						<h2 class="text-primary mb-2" th:text="${totalMotos}">0</h2>
						<p class="text-muted mb-0"><small>Motos Monitoradas</small></p>
					</div>
				</div>
			</div>
			<div class="col-md-3 mb-3">
				<div class="card border-success stats-card">
					<div class="card-body text-center">
						<h5 class="card-title"><i class="fas fa-check-circle text-success fa-2x mb-2"></i><br>Prontas</h5>
						<h2 class="text-success mb-2" th:text="${motosProntas}">0</h2>
						<p class="text-muted mb-0"><small>Disponíveis</small></p>
					</div>
				</div>
			</div>
			<div class="col-md-3 mb-3">
				<div class="card border-warning stats-card">
					<div class="card-body text-center">
						<h5 class="card-title"><i class="fas fa-tools text-warning fa-2x mb-2"></i><br>Manutenção</h5>
						<h2 class="text-warning mb-2" th:text="${motosManutencao}">0</h2>
						<p class="text-muted mb-0"><small>Em Reparo</small></p>
					</div>
				</div>
			</div>
			<div class="col-md-3 mb-3">
				<div class="card border-info stats-card">
					<div class="card-body text-center">
						<h5 class="card-title"><i class="fas fa-road text-info fa-2x mb-2"></i><br>Alugadas</h5>
						<h2 class="text-info mb-2" th:text="${motosAlugadas}">0</h2>
						<p class="text-muted mb-0"><small>Em Uso</small></p>
					</div>
				</div>
			</div>
		</div>

		<!-- Busca por Placa -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="card border-primary">
					<div class="card-header bg-primary text-white">
						<h5 class="mb-0"><i class="fas fa-search me-2"></i>Buscar Moto por Placa - ESP32</h5>
					</div>
					<div class="card-body">
						<form th:action="@{/disruptive-architectures/buscar}" method="post">
							<div class="row g-3">
								<div class="col-md-10">
									<label class="form-label">Digite a Placa da Moto</label>
									<input type="text" class="form-control form-control-lg" name="placa" 
										placeholder="Ex: ABC1234" maxlength="10" required
										th:value="${placaBuscada != null ? placaBuscada : ''}">
									<small class="text-muted">O LED da moto piscará por 30 segundos quando encontrada</small>
								</div>
								<div class="col-md-2 d-flex align-items-end">
									<button type="submit" class="btn btn-primary btn-lg w-100">
										<i class="fas fa-search me-1"></i>Buscar
									</button>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<!-- Resultado da Busca - SEMPRE EXIBIR SE BUSCOU -->
		<div class="row mb-4" th:if="${placaBuscada != null and placaBuscada != ''}">
			<div class="col-12">
				<!-- Moto Encontrada -->
				<div class="card border-success mb-3" th:if="${motoEncontrada != null}">
					<div class="card-header bg-success text-white">
						<h5 class="mb-0">
							<i class="fas fa-check-circle me-2"></i>Moto Encontrada via ESP32
						</h5>
					</div>
					<div class="card-body">
						<div class="row">
							<div class="col-md-6">
								<h6 class="text-primary"><i class="fas fa-motorcycle me-2"></i>DADOS DA MOTO ENCONTRADA</h6>
								<hr>
								<p class="mb-3"><strong>Placa:</strong> 
									<span class="badge bg-primary fs-5 px-3 py-2" th:text="${motoEncontrada.placa}"></span>
								</p>
								<p class="mb-3"><strong>Chassi:</strong> 
									<span class="fs-5" th:text="${motoEncontrada.chassi}"></span>
								</p>
								<p class="mb-3"><strong>Modelo:</strong> 
									<span class="fs-5" th:text="${motoEncontrada.motor}"></span>
								</p>
								<p class="mb-3"><strong>ID:</strong> 
									<span class="badge bg-secondary fs-6" th:text="${motoEncontrada.id}"></span>
								</p>
							</div>
							<div class="col-md-6">
								<h6 class="text-success"><i class="fas fa-map-marker-alt me-2"></i>LOCALIZAÇÃO VIA ESP32</h6>
								<hr>
								<div th:if="${localizacaoMotoEncontrada != null}">
									<!-- LED VIRTUAL PISCANDO - DESTAQUE -->
									<div class="alert alert-danger mb-3" th:if="${ledInfo != null and (ledInfo.ledVirtualPiscando == true or ledInfo.ativo == true)}">
										<h6 class="mb-2">
											<i class="fas fa-circle blink text-danger me-2"></i>
											<strong>LED VIRTUAL PISCANDO</strong>
										</h6>
										<p class="mb-0">
											O LED virtual da moto está piscando. 
											<span th:if="${ledInfo.tempoRestanteSegundos != null and ledInfo.tempoRestanteSegundos > 0}">
												<span th:text="${ledInfo.tempoRestanteSegundos}"></span> segundos restantes.
											</span>
										</p>
									</div>
									
									<!-- LOCALIZAÇÃO VIA OPERAÇÃO -->
									<div class="alert alert-info mb-3">
										<h6 class="mb-2"><i class="fas fa-map-pin me-2"></i><strong>LOCALIZAÇÃO</strong></h6>
										<p class="mb-1">
											<strong>Lugar onde está (via operação):</strong> 
											<span class="badge bg-info fs-5 px-3 py-2" th:text="${localizacaoMotoEncontrada.localizacaoOperacao != null ? localizacaoMotoEncontrada.localizacaoOperacao : (localizacaoMotoEncontrada.area != null ? localizacaoMotoEncontrada.area : 'Pátio Principal')}"></span>
										</p>
										<p class="mb-1" th:if="${localizacaoMotoEncontrada.posicaoX != null and localizacaoMotoEncontrada.posicaoY != null}">
											<strong>Posição:</strong> 
											<span class="badge bg-primary fs-5 px-3 py-2">
												X: <span th:text="${localizacaoMotoEncontrada.posicaoX}"></span> | 
												Y: <span th:text="${localizacaoMotoEncontrada.posicaoY}"></span>
											</span>
										</p>
										<p class="mb-0" th:if="${localizacaoMotoEncontrada.posicaoX == null or localizacaoMotoEncontrada.posicaoY == null}">
											<strong>Posição:</strong> 
											<span class="badge bg-secondary fs-6">Não disponível</span>
										</p>
									</div>
									
									<!-- STATUS -->
									<p class="mb-3"><strong>Status:</strong> 
										<span class="badge fs-5 px-3 py-2" 
											th:classappend="${localizacaoMotoEncontrada.status == 'PRONTA'} ? 'bg-success' : 
												(${localizacaoMotoEncontrada.status == 'ALUGADA'}) ? 'bg-info' : 
												(${localizacaoMotoEncontrada.status != null and #strings.contains(localizacaoMotoEncontrada.status, 'MANUTENCAO')}) ? 'bg-warning' : 'bg-secondary'"
											th:text="${localizacaoMotoEncontrada.status}"></span>
									</p>
									
									<!-- INFORMAÇÕES EXTRAS -->
									<div class="card border-secondary mb-3">
										<div class="card-header bg-secondary text-white">
											<h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>INFORMAÇÕES ESP32</h6>
										</div>
										<div class="card-body">
											<p class="mb-2"><strong>ESP32 ID:</strong> 
												<span class="badge bg-dark fs-6" th:text="${localizacaoMotoEncontrada.esp32Id}"></span>
											</p>
											<p class="mb-2"><strong>Sinal GPS:</strong> 
												<span class="badge bg-info fs-6" th:text="${localizacaoMotoEncontrada.sinalGPS} + '%'"></span>
											</p>
											<p class="mb-2"><strong>Sinal Bluetooth:</strong> 
												<span class="badge bg-primary fs-6" th:text="${localizacaoMotoEncontrada.sinalBluetooth} + '%'"></span>
											</p>
											<p class="mb-2" th:if="${localizacaoMotoEncontrada.bateria != null}">
												<strong>Bateria:</strong> 
												<span class="badge fs-6" 
													th:classappend="${localizacaoMotoEncontrada.bateria < 20} ? 'bg-danger' : 'bg-success'"
													th:text="${localizacaoMotoEncontrada.bateria} + '%'"></span>
											</p>
											<p class="mb-0" th:if="${localizacaoMotoEncontrada.area != null}">
												<strong>Área:</strong> 
												<span class="badge bg-secondary fs-6" th:text="${localizacaoMotoEncontrada.area}"></span>
											</p>
										</div>
									</div>
									
									<!-- COORDENADAS GPS -->
									<div class="card border-warning mb-3">
										<div class="card-header bg-warning text-dark">
											<h6 class="mb-0"><i class="fas fa-globe me-2"></i>COORDENADAS GPS</h6>
										</div>
										<div class="card-body">
											<p class="mb-2"><strong>Latitude:</strong> 
												<span class="badge bg-warning text-dark fs-6 px-3 py-2" th:text="${#numbers.formatDecimal(localizacaoMotoEncontrada.latitude, 1, 6)}"></span>
											</p>
											<p class="mb-0"><strong>Longitude:</strong> 
												<span class="badge bg-warning text-dark fs-6 px-3 py-2" th:text="${#numbers.formatDecimal(localizacaoMotoEncontrada.longitude, 1, 6)}"></span>
											</p>
										</div>
									</div>
									
									<div class="mt-3">
										<a th:href="'https://www.google.com/maps?q=' + ${localizacaoMotoEncontrada.latitude} + ',' + ${localizacaoMotoEncontrada.longitude}" 
											target="_blank" class="btn btn-primary btn-lg w-100 mb-2">
											<i class="fas fa-directions me-1"></i>Ver no Google Maps
										</a>
									</div>
								</div>
								<div th:if="${localizacaoMotoEncontrada == null}">
									<p class="text-muted">Localização será exibida quando a moto for encontrada.</p>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<!-- Moto NÃO Encontrada -->
				<div class="card border-danger" th:if="${motoEncontrada == null}">
					<div class="card-header bg-danger text-white">
						<h5 class="mb-0">
							<i class="fas fa-times-circle me-2"></i>Moto Não Encontrada
						</h5>
					</div>
					<div class="card-body">
						<p class="mb-0">
							<strong>Placa buscada:</strong> 
							<span class="badge bg-danger fs-5 px-3 py-2" th:text="${placaBuscada}"></span>
						</p>
						<p class="mt-3 mb-0 text-muted">
							Não foi possível encontrar uma moto com a placa informada. Verifique se a placa está correta e tente novamente.
						</p>
					</div>
				</div>
			</div>
		</div>

		<!-- Análise IA -->
		<div class="row mb-4" th:if="${analiseIA != null}">
			<div class="col-12">
				<div class="card border-primary">
					<div class="card-header bg-primary text-white">
						<h5 class="mb-0"><i class="fas fa-robot me-2"></i>Análise Inteligente (IA Generativa)</h5>
					</div>
					<div class="card-body">
						<p class="mb-0" th:text="${analiseIA}"></p>
					</div>
				</div>
			</div>
		</div>

		<!-- Lista de Motos com Status -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="card">
					<div class="card-header bg-dark text-white">
						<h5 class="mb-0">
							<i class="fas fa-list me-2"></i>Motos Monitoradas via ESP32
							<span class="badge bg-light text-dark ms-2" th:text="${totalMotos} + ' motos'"></span>
						</h5>
					</div>
					<div class="card-body">
						<div class="table-responsive" th:if="${localizacoes != null and !#lists.isEmpty(localizacoes)}">
							<table class="table table-striped table-hover">
								<thead>
									<tr>
										<th>Placa</th>
										<th>Modelo</th>
										<th>Status</th>
										<th>GPS</th>
										<th>Bluetooth</th>
										<th>ESP32 ID</th>
										<th>Bateria</th>
										<th>Alertas</th>
										<th>Ações</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="loc : ${localizacoes}" th:if="${loc != null and loc.moto != null}">
										<td><span class="badge bg-primary" th:text="${loc.moto.placa}"></span></td>
										<td th:text="${loc.moto.motor != null ? loc.moto.motor : 'N/A'}"></td>
										<td>
											<span class="badge" 
												th:classappend="${loc.status == 'PRONTA'} ? 'bg-success' : 
													(${loc.status == 'ALUGADA'}) ? 'bg-info' : 
													(${loc.status != null and (#strings.contains(loc.status, 'MANUTENCAO') or #strings.contains(loc.status, 'REPARO'))}) ? 'bg-warning' : 'bg-secondary'"
												th:text="${loc.status != null ? loc.status : 'PENDENTE'}"></span>
										</td>
										<td><span class="badge bg-info" th:text="${loc.sinalGPS != null ? (loc.sinalGPS + '%') : 'N/A'}"></span></td>
										<td><span class="badge bg-primary" th:text="${loc.sinalBluetooth != null ? (loc.sinalBluetooth + '%') : 'N/A'}"></span></td>
										<td><span class="badge bg-dark" th:text="${loc.esp32Id != null ? loc.esp32Id : 'N/A'}"></span></td>
										<td>
											<span class="badge" 
												th:classappend="${loc.bateria != null and loc.bateria < 20} ? 'bg-danger' : 'bg-success'"
												th:text="${loc.bateria != null ? (loc.bateria + '%') : 'N/A'}"></span>
										</td>
										<td>
											<span th:if="${loc.alertas != null and !#lists.isEmpty(loc.alertas)}" 
												class="badge bg-danger" 
												th:each="alerta : ${loc.alertas}"
												th:text="${alerta}"></span>
											<span th:if="${loc.alertas == null or #lists.isEmpty(loc.alertas)}" 
												class="text-muted">-</span>
										</td>
										<td>
											<button type="button" class="btn btn-sm btn-success" 
												th:onclick="'ativarLED(\'' + ${loc.moto.placa} + '\')'">
												<i class="fas fa-lightbulb me-1"></i>LED
											</button>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
						<div th:if="${localizacoes == null or #lists.isEmpty(localizacoes)}" class="alert alert-info">
							<i class="fas fa-info-circle me-2"></i>Nenhuma moto cadastrada no sistema.
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Botão Voltar -->
		<div class="row mt-4">
			<div class="col-12">
				<a href="/index" class="btn btn-secondary">
					<i class="fas fa-arrow-left me-1"></i>Voltar
				</a>
			</div>
		</div>
	</div>
	
	<!-- Botão de Atualização Flutuante -->
	<button type="button" class="btn btn-primary refresh-btn" onclick="location.reload()" title="Atualizar Dashboard">
		<i class="fas fa-sync-alt fa-lg"></i>
	</button>

	<div th:replace="~{fragmentos :: scripts}" />
	
	<script th:inline="javascript">
		/*<![CDATA[*/
		var localizacoes = /*[[${localizacoes}]]*/ [];
		var ledInfo = /*[[${ledInfo}]]*/ null;
		
		// Função para ativar LED
		function ativarLED(placa) {
			if (!placa) {
				alert('Placa não informada');
				return;
			}
			
			fetch('/disruptive-architectures/ativar-led', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
				},
				body: 'placa=' + encodeURIComponent(placa)
			})
			.then(response => response.json())
			.then(data => {
				if (data.sucesso) {
					alert('LED ativado com sucesso! ' + data.mensagem);
					location.reload();
				} else {
					alert('Erro: ' + data.mensagem);
				}
			})
			.catch(error => {
				console.error('Erro:', error);
				alert('Erro ao ativar LED');
			});
		}
		/*]]>*/
	</script>
</body>
</html>
